{% extends 'cadmin/raster.html' %}
{% load i18n %}
{% load goodrain_extras %}
{% block main-content %}
<div role="tabpanel" class="tab-pane active">
    <section class="wrapper site-min-height">
        <p class="tittext">配置列表&nbsp;&nbsp;&nbsp;&nbsp;<span><button type="button" class="btn btn-success" id="add_new_config">新增配置</button></span></p>
        <div class="panel-body">
            <table class="table table-striped table-advance table-hover" style="margin-bottom: 0px;" id="config_list">
                <thead>
                    <tr>
                        <th>配置名</th>
                        <th>配置描述</th>
                        <th>详情</th>
                        <th><i class=" fa fa-edit"></i> 操作</th>
                    </tr>
                </thead>

                <tbody>

                    {% for config in config_list %}
                        <tr config_key="{{config.key}}">
                            <td>{{config.key}}</td>
                            <td>{{config.desc}}</td>
                            <td><a href="#" class="config-detail">详情</a></td>
                            <td>
                                <button type="button" class="config-edit btn btn-danger btn-xs" ><i class="fa fa-edit"></i></button>&nbsp;&nbsp;&nbsp;
                                <button type="button" class="config-delete btn btn-danger btn-xs" ><i class="fa fa-times"></i></button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>

            </table>

        </div>

    </section>
</div>

<div id="detail-box" title="配置详情">
    <div id="detail-message">

    </div>
</div>

<script>
    $(document).ready(function () {



    });
    // 添加新配置
    $("#add_new_config").on('click', function () {
        var msg = '<tr colspan=7></tr>';
        msg = msg + '<tr>';
        msg = msg + '<td><input name="config_key" placeholder="(^[A-Z][A-Z0-9_])" value=""></td>';
        msg = msg + '<td><input name ="config_desc" value=""></td>'
        msg = msg + '<td><div class="btn-toolbar" role="toolbar">' +
                '<div class="btn-group" role="group">' +
                '<button type="button" class="config-save btn btn-success btn-xs" "><i class="fa fa-check"></i></button>' +
                '</div>' +
                '<div class="btn-group" role="group">' +
                '<button type="button" class="config-cancel btn btn-danger btn-xs" "><i class="fa fa-times"></i></button></td>' +
                '</div>' +
                '</div></td>';
        msg = msg + '</tr>';
        $("#config_list tr:last").after(msg);

        $('.config-cancel').unbind('click').bind('click', config_cancel);
        $('.config-save').unbind('click').bind('click', config_save);


    });

    $('.config-cancel').click(config_cancel);
    $('.config-save').click(config_save);
    $('.config-delete').click(config_delete);
    $('.config-edit').click(config_edit);
    $('.config-detail').click(config_detail);

    //取消添加操作
    function config_cancel(event) {
        var cancel_tr = $(this).closest('tr');
        cancel_tr.remove();
    }

    //添加配置
    function config_save(event) {
        var dict = {csrfmiddlewaretoken: $.cookie('csrftoken'), "action": "add_config"};
        var add_config = $(this).closest('tr');
        add_config.find('input').each(function() {
            name = $(this).attr("name");
            value = $(this).val();
            dict[name] = value;
        });
        url = "/cadmin/ajax/custome-config";

        $.post(url, dict, function(res) {
            if (res.success) {
                add_config.find('.btn-toolbar').remove();
                window.location.reload();

            } else {
                swal(res.info)
            }
        });
    }
    //删除配置
    function config_delete(event) {
        var dict = {csrfmiddlewaretoken: $.cookie('csrftoken'), "action": "del_config"};
        var del_tr = $(this).closest('tr');
        var config_key = del_tr.attr("config_key");
        dict["config_key"] = config_key;
        url = "/cadmin/ajax/custome-config";
        $.post(url, dict, function(res) {
            if (res.success) {
                del_tr.remove();
            }
        });

    }
    // 编辑配置
    function config_edit(event){
        var detail_tr = $(this).closest('tr');
        var config_key = detail_tr.attr("config_key");
        window.location.href = "/cadmin/edit?config_key="+config_key;

    }

    // 显示详情
    function config_detail(event){

        var detail_tr = $(this).closest('tr');
        var config_key = detail_tr.attr("config_key");

        $.ajax({
            type: "post",
            url: "/cadmin/ajax/detail",
            data: {"config_key":config_key},
            cache: false,
            beforeSend: function (xhr, settings) {
                var csrftoken = $.cookie('csrftoken');
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success: function (msg) {
                if (msg.success) {
                    $( "#detail-box" ).dialog({

                        autoOpen: true,
                        show: {
                            effect: "blind",
                            duration: 200
                        },
                        hide: {
                            effect: "blind",
                            duration: 200
                        }
                    });

                    $("#detail-message").html(msg.info);
                } else {
                    swal("获取详情异常");
                }

            },
            error: function () {
                swal("内部错误");
            }
        })


    }



</script>

{% endblock %}


