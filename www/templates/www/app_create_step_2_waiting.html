{% extends 'www/raster.html' %} {% load i18n %}
{% load staticfiles %}
{% block extracss %}
{{ block.super }}
<link rel="stylesheet" href='{% static "www/css/base.css" %}' />
<link rel="stylesheet" href='{% static "www/css/newappstep.css" %}' />
{% endblock %}
{% block main-content%}
<section class="wrapper site-min-height">
	<!-- page start-->
	<!-- page end-->
	<section class="main-box">
		<h3 class="main-tit">从源码创建应用</h3>
        <div class="app-step clearfix">
            <p class="sed"><span>1</span><cite>创建应用</cite></p>
            <p class="sed"><span>2</span><cite>代码同步</cite></p>
            <p><span>3</span><cite>应用设置</cite></p>
            <p><span>4</span><cite>高级选项</cite></p>
        </div>
	    <form class="cmxform form-horizontal tasi-form" id="commentForm" method="post" action="" novalidate="novalidate">
			<input type="hidden" id="tenantName" name="tenantName" value="{{tenantName}}" />
			<input type="hidden" id="service_name" name="service_name" value="{{tenantService.service_alias}}" />
	        <div class = "mainbox">
	        	<div class="second-loading" id="second-loading">
	        		<p class="second-tit">正在从仓库同步代码！</p>
	        		<p class="second-tips-loading">
	        			<span>代码源：<cite>{{httpGitUrl}}</cite> 由于代码量及网络环境差异，等待时间可能较长。你可以关闭当前页面去处理其他事务，稍后可在我的应用中继续操作。</span>
	        			<span>如果是通过好雨 Git 新建的项目，请往上述地址提交代码。当前帐号的用户名和密码即为好雨 Git 用户名和密码。</span>
	        		</p>
	        		<div  style="width: 250px; margin:0 auto;" class="clearfix">
	        			<a class="redbtn seconbtn" style="cursor: pointer; float: left; margin:0 5px;" onclick="app_create_delete();" >停止创建</a>
	        			<p class="waitbtn" style="float: left; margin:0 5px;">请稍等</p>
	        		</div>
	        	</div>
	        	<div  style="display: none;" id="git-success">
		        	<p class="second-tit" id="git_code_upload" ></p>
		        	<p class="second-tips-loading">
		        		<span>代码源：<cite>{{httpGitUrl}}</cite></span>
		        	</p>
	        	</div>
	        	<div style="text-align: center; display: none;" id="git_btn">
	        		<a class="redbtn seconbtn" id="Btndelete" style="cursor: pointer;" onclick="app_create_delete();">停止创建</a>
	        		<a class="greenbtn seconbtn" id="BtnSecond" style="cursor: pointer;">下一步</a>
	        	</div>
	        </div>
    	</form>
    </section>
</section>
<script>
var gitcodechecktimmer;
var requestNumber = 0
$(function() {
	//$('#BtnSecond').attr('disabled', "true");
	getGitCodeCheck();
	$('#BtnSecond').click(
		function() {
			var tenantName = $('#tenantName').val();
			var service_name = $('#service_name').val();
			window.location.href = "/apps/" + tenantName + "/"+ service_name + "/app-setting/";
	});
});

function getGitCodeCheck() {
	var tenantName = $('#tenantName').val();
	var service_name = $('#service_name').val();
	if (service_name != "" && service_name != undefined) {
		requestNumber = requestNumber + 1
		$.ajax({
			type : "GET",
			url : "/ajax/" + tenantName + "/" + service_name
					+ "/check/?requestNumber=" + requestNumber,
			cache : false,
			success : function(msg) {
				var dataObj = msg;
				if (dataObj["status"] == "checked") {
					clearTimeout(gitcodechecktimmer);
					$("#second-loading").hide();
					$("#git-success").show();
					$("#git_btn").show();
					$("#git_code_upload").html(
							"代码已同步，语言识别为 " + dataObj["language"]);
					//$("#BtnSecond").removeAttr('disabled')
					$("#BtnSecond").show();
				} else if (dataObj["status"] == "check_error") {
					$("#second-loading").hide();
					$("#git-success").show();
					$("#git_btn").show();
					$("#git_code_upload").html("语言未识别，请重新提交代码...");
					$("#BtnSecond").hide();
				}
			},
			error : function() {
				// swal("系统异常");
			}
		})
		
		gitcodechecktimmer=setTimeout("getGitCodeCheck()",1000*Math.ceil(requestNumber / 5)+3000)
	}
}

function app_create_delete() {
	swal({
		title: "确定要停止创建当前的应用吗？",
		type: "warning",
	    showCancelButton: true,
		confirmButtonColor: "#DD6B55",
		confirmButtonText: "确定",
		cancelButtonText: "取消",
		closeOnConfirm: false,
		closeOnCancel: false
	}, function (isConfirm) {
		if(isConfirm) {
			var tenantName = $('#tenantName').val();
			var service_name = $('#service_name').val();
			$.ajax({
				type : "POST",
				url : "/ajax/" + tenantName + "/" + service_name + "/manage/",
				data : "action=delete",
				cache : false,
				beforeSend : function(xhr, settings) {
					var csrftoken = $.cookie('csrftoken');
					xhr.setRequestHeader("X-CSRFToken", csrftoken);
					swal({
						title: "正在执行删除操作，请稍候...",
						text: "5秒后自动关闭",
						timer: 5000,
						showConfirmButton : false
					});
				},
				success : function(msg) {
					var dataObj = msg
					if (dataObj["status"] == "success") {
						swal("操作成功");
						window.location.href = "/apps/"+tenantName+"/service-entrance/"
					} else if (dataObj["status"] == "often") {
						swal("上次操作正在进行中，稍后再试")
					}else if (dataObj["status"] == "dependency") {
						swal("当前服务被依赖不能删除");
					} else {
						swal("操作失败");
					}
				},
				error : function() {
					swal("系统异常");
				}
			});
		}else{
			swal.close();
		}
	});
}
</script>
{% endblock %}
