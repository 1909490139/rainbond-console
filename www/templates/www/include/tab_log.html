<!-- log start -->
<div role="tabpanel" class="tab-pane active">
  <div>
  	<button type="button" class="btn btn-success" onclick="_pause()" id="logbtn">暂停</button>
  	<button style="margin-left: 15px;" type="button" class="btn btn-success" id="logbtn_out">日志输出</button>&nbsp;&nbsp;&nbsp;&nbsp;

    <a href="/apps/{{tenantName}}/{{serviceAlias}}/history-log/" target="_blank">历史日志下载</a>
  	&nbsp;&nbsp;&nbsp;&nbsp;
  	<a href="/apps/{{tenantName}}/{{serviceAlias}}/latest-log/" target="_blank">最新1000条日志</a>
  </div>
  <div id="docker_log" role="tabpanel" class="tab-pane active  blackbg">
  </div>
</div>

<!-- log end-->
<script>
	var service_id='{{tenantServiceInfo.service_id}}'
	String.prototype.trim = function() {
	    return this.replace(/(^\s*)|(\s*$)/g, "");
	}
	
	var pauseFlag = "start";
	
	function getLog(){
		$.ajax({
       	  type: "GET",
    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/log",
    		  data: "action=service",
    		  cache: false,
    		  beforeSend: function(xhr, settings){
    		      var csrftoken = $.cookie('csrftoken');
    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    		  },
    	  	  success: function(msg) {
    	  		var dataObj = msg;
    	  		$("#docker_log").html(dataObj["log"])
    		  },
    		  error: function(){
    			//swal("系统异常");
      	  	}
       })
	}
	$(document).ready(function () {
		getLog();
		extPushWebSocketClient.prototype = {
   			onMessage : function(msg) {
   				if(typeof(msg) !="undefined" && pauseFlag == "start"){
       				var msgs = msg.split(":")
       				if(msgs[0].trim() != "deploy" && msgs[0].trim() != "compile"){
       					var finalMsg=""
       					var arr=$("#docker_log").html().split('<br>');
       					var totalSize=150;
       					if(arr.length > totalSize){
       						for(var i = 0; i < totalSize; i++){
       							finalMsg += arr[totalSize-1-i]+"<br/>"
       						}
       					}else{
       						finalMsg = $("#docker_log").html()
       					}
       					finalMsg = msg.substr(14) +"<br/>"+ finalMsg
       					$("#docker_log").html(finalMsg)       					
       				}
   				}
   			}
    	}
   		var connect = new extPushWebSocketConnect('{{websocket_uri}}');
   		connect.init(new extPushWebSocketClient(),service_id, "submsg", "submsg","123456789","987654321");
    });
	
	function _pause(){
		if(pauseFlag=="stop"){
			pauseFlag="start";
			$('#logbtn').html("暂停");
		}else if(pauseFlag=="start"){
			pauseFlag="stop";
			$('#logbtn').html("开始");
		}
	}
	 function layerlog(tit,ptit,ptext,onoff){
       var odiv='<div class="layerbg"><div class="layermainlog"><p class="titlog">'+ tit +'</p><a href="javascript:;" class="closebtn"><i class="fa fa-times"></i></a></div></div>'
       var optit = '<p class="layertitlog">' + ptit +'</p>'; 
       var optext = '<p class="tipstextlog">' + ptext + '</p>';
       var obtntwo = '<p><a href ="javascript:;" class="greenbtn">确定</a><a href ="javascript:;" class="redbtn">取消</a></p>';
       var obtn = '<p><a href ="javascript:;">好的</a></p>';
       $(odiv).appendTo("body");
       $(optit).appendTo($(".layermainlog"));
       $(optext).appendTo($(".layermainlog"));
       if(onoff){
          $(obtntwo).appendTo($(".layermainlog"));
       }else{
          $(obtn).appendTo($(".layermainlog"));
       }
   }

   $(function(){
      $("#logbtn_out").click(function(){
          layerlog("日志输出设置","指定日志应用","下方为当前团队已经安装的日志应用列表，可以为当前应用指定一个或多个日志应用来接受日子数据的数日。目前支持日志的应用有：elasticsearch、mongodb、influxdb等，如需安装可直接点击文字去部署。",true);
      });
   });
</script>

















>>>>>>> ada3f91c12b2f063e5f30e62890618d539064928
