<!-- deployed start -->
<div role="tabpanel" class="tab-pane active text-center" id="deployed">
  <div class="row">
    <div class="col-sm-3">
      <p>状态</p>
      <span class="badge badge-sm label-success" style="font-size:18pt" id="service_status" name="service_status">未知</span>
    </div>
    <div class="col-sm-3">
      <p>内存使用</p>
      <p style="font-size:18pt" id="service_memory" name="service_memory">{{totalMemory}}M</p>
    </div>
    <!--<div class="col-sm-3">
      <p>磁盘占用</p>
      <p style="font-size:18pt" id="service_disk" name="service_disk">0M</p>
    </div>
    <div class="col-sm-3">
      <p>流量</p>
      <p style="font-size:18pt" id="service_network" name="service_network">0K</p>
    </div>
     -->
  </div>
  <div class="row">
    <div class="col-lg-12">
      <section class="panel text-left">
        <header class="panel-heading">控制</header>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-8 text-left">
                {% ifequal tenantServiceInfo.category "application" %}
                    {% if user.is_sys_admin or 'app_publish' in user.actions or publish_service %}
                        <button type="button" class="btn btn-success" id="service_publish" onclick="window.open('/apps/{{tenantName}}/{{serviceAlias}}/publish');"><i class="fa fa-eye"></i>发布</button>
                    {% endif %}
                    
                    {% if 'code_deploy' in user.actions %}
                        <button type="button" class="btn btn-info " id="onekey_deploy" onclick="service_oneKeyDeploy('{{tenantServiceInfo.category}}','{{tenantServiceInfo.service_alias}}','{{tenantName}}','no');"><i class="fa fa-refresh"></i> 一键部署</button>
                    {% endif %}
                    
                {% endifequal %}

                {% if hasHttpServices %}
					{% if visit_port_type == "multi_outer" %}
						<select class="form-control-inline" id="multi_ports" name="multi_port_bind" style="width:100px;">

							{% for port in http_outer_service_ports %}
    							{% if port.container_port == serviceDomain.container_port %}
        							<option value="{{ port.container_port }}"
        									selected="selected">{{ port.container_port }}</option>
        							{% else %}
        							<option value="{{ port.container_port }}">{{ port.container_port }}</option>
    							{% endif %}
							{% endfor %}

						</select>
					{%endif%}
                    <button type="button" class="btn btn-success" id="service_visitor" onclick="visit()"><i class="fa fa-eye"></i>访问</button>
                {% endif  %}
                 
                {% ifequal tenantServiceInfo.service_type "mysql" %}
                  {% if service_manager.deployed %}
                    {% if 'manage_service' in user.actions %}
                      <button type="button" class="btn btn-success" id="service_visitor" onclick="window.open('{{service_manager.url}}');"><i class="fa fa-eye"></i>管理</button>
                    {% endif %}
                  {% else %}
                    {% if 'manage_service' in user.actions %}
                      <button type="button" class="btn btn-info" id="service_visitor" onclick="window.open('{{service_manager.url}}');"><i class="fa fa-eye"></i>添加管理服务</button>
                    {% endif %}
                  {% endif %}
                {% endifequal %}
                {% if updateService %}
                    <button type="button" class="btn btn-danger" id="service_image_operate" onclick="service_image_reboot('{{tenantServiceInfo.service_id}}','{{tenantServiceInfo.service_alias}}','{{tenantName}}');" ><i class="fa  fa-power-off"></i>服务更新</button>
                {% endif %}
                </div>
                {% if 'manage_service' in user.actions %}
                <div class="col-xs-4 text-right">
                    <input type="hidden" id="service_status_value" name="service_status_value" value="" />
                    <button type="button" class="btn btn-danger" id="service_status_operate" onclick="service_onOperation('{{tenantServiceInfo.service_id}}','{{tenantServiceInfo.service_alias}}','{{tenantName}}');" ><i class="fa  fa-power-off"></i><font id="font{{tenantServiceInfo.service_id}}">关闭</font></button>
                </div>
                {% endif %}
            </div>
          </div>
      </section>
    </div>
  </div>
  
  {% if user.is_sys_admin or docker_console or tenantName == 'gooood' or tenantName == 'gooood0' %}
  <div class="row">
    <div class="col-lg-12 text-left">
       <section class="panel">
         <header class="panel-heading"><button name="join_container" id="join_container" onclick="join_container();"/> 管理容器 </header>
         <table class="table table-hover">
           <thead>
             <tr>
               <th>容器名</th>
               <th>操作</th>
             </tr>
           </thead>
           <tbody id="cur_container_content">
            
           </tbody>
         </table>
       </section>
     </div>
  </div>
  {% endif %}

<!--
	{% if user.is_sys_admin %}
	<div class="row">
		<div class="col-lg-12 text-left">
			<section class="panel">
				<header class="panel-heading"><button name="container_stats" id="show_stats" onclick="showStatus();"/> 容器状态 </header>
				<table class="table table-hover">
					<thead>
					<tr>
						<th>容器名</th>
						<th>已使用内存</th>
						<th>最大内存</th>
						<th>内存百分比</th>
						<th>CPU百分比</th>
					</tr>
					</thead>
					<tbody id="container_stats">

					</tbody>
				</table>
			</section>
		</div>
	</div>
	{% endif %}
 -->
 
  {% if 'manage_service' in user.actions %}
  {% with curServiceEnvVarList=envMap|mkey:tenantServiceInfo.service_id %}
  <div class="row">
    <div class="col-lg-12 text-left">
       <section class="panel">
         <header class="panel-heading">连接信息</header>
         <table class="table table-hover">
           <thead>
             <tr>
               <th>说明</th>
               <th>变量名</th>
               <th>变量值</th>
             </tr>
           </thead>
           <tbody>
            {% for curServiceEnvVar in curServiceEnvVarList %}
                {% if curServiceEnvVar.name != "" %}
                 <tr>
                   <td>{{curServiceEnvVar.name}}</td>
                   <td>{{curServiceEnvVar.attr_name}}</td>
                   <td>{{curServiceEnvVar.attr_value}}</td>
                 </tr>
                 {% endif %}
            {% endfor %}
           </tbody>
         </table>
       </section>
     </div>
  </div>
  {% endwith %}
  {% endif %}
  <div class="row">
    <div class="col-lg-12 text-left">
        <section class="panel">
           <header class="panel-heading">关键日志</header>
            <div class="panel-body">
              <div class="text-left  logtxtbox">
                <input type="hidden" name="service_name" id="service_name" value="{{tenantServiceInfo.service_alias}}"/>
                <p id="keylog"></p>
              </div>
            </div>
        </section>
    </div>
  </div>
</div>
<!-- deployed end-->
<script>
	var service_id='{{tenantServiceInfo.service_id}}'
	String.prototype.trim = function() {
	    return this.replace(/(^\s*)|(\s*$)/g, "");
	}
	function checkStatus(){
    	$.ajax({
       	  type: "GET",
    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/detail/",
    		  cache: false,
    		  beforeSend: function(xhr, settings){
    		      var csrftoken = $.cookie('csrftoken');
    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    		  },
    	  	  success: function(msg) {
    	  		  var obj=msg;
	    	  	  if(obj["status"]!="failure"){
	    		  	  if(obj["status"]=="running"){
	    		  		$("#service_status_value").val("stop")
	    		  		$("#font"+service_id).html("关闭")
	    		  		$("#service_status_operate").show()
	    		  		$("#onekey_deploy").show()
	    		  		$("#onekey_deploy").removeAttr("disabled")
	    		  		$("#service_status").html("运行中")
	    		  		$("#service_status_operate").show()
	    		  		$("#service_visitor").show()
	    		  		$("#service_status").attr("class","badge badge-sm label-success")
	    		  	  }else if(obj["status"]=="starting"){
	    		  	    $("#service_status_value").val("stop")
                        $("#font"+service_id).html("关闭")
                        $("#service_status_operate").show()
                        $("#onekey_deploy").show()
                        $("#onekey_deploy").removeAttr("disabled")
                        $("#service_status").html("启动中")
                        $("#service_status_operate").show()
                        $("#service_status").attr("class","badge badge-sm label-success")
		    		  }else if(obj["status"]=="unusual"){
		    			$("#service_status_value").val("")
		    		  	$("#font"+service_id).html("启动")
		    		  	$("#service_status_operate").show()
		    		  	$("#onekey_deploy").show();
		    		  	$("#service_status").html("运行异常")
		    		    $("#service_status_operate").show()
		    			$("#service_visitor").hide();
						$("#multi_ports").hide()
		    			$("#service_status").attr("class","badge badge-sm label-danger")
		    		  }else if(obj["status"]=="closed" || obj["status"]=="Owed" || obj["status"]=="expired"){
		    			$("#service_status_value").val("restart")
		    		  	$("#font"+service_id).html("启动")
		    		  	$("#service_status_operate").show()
		    		  	$("#onekey_deploy").show()
		    		  	$("#onekey_deploy").removeAttr("disabled")
		    		  	if(obj["status"]=="closed"){
		    		  		$("#service_status").html("已关闭")
		    		  		$("#service_status").attr("class","badge badge-sm label-success")
		    		  	}else{
		    		  		$("#service_status").html("余额不足已关闭")
		    		  		$("#service_status").attr("class","badge badge-sm label-danger")
		    		  	}
		    		  	$("#service_status_operate").show()
		    		  	$("#service_visitor").hide();
						$("#multi_ports").hide()
		    		  }else if(obj["status"]=="undeploy"){
		    			$("#service_status_value").val("")
		    			$("#font"+service_id).html("未部署")
		    			$("#service_status_operate").hide();
		    			$("#onekey_deploy").show()
		    			$("#onekey_deploy").removeAttr("disabled")
		    			$("#service_status").html("未部署")
		    			$("#service_status_operate").hide();
		    			$("#service_visitor").hide();
		    			$("#service_status").attr("class","badge badge-sm label-success")
		    		  }else{
		    			$("#service_status_value").val("")
			    		$("#font"+service_id).html("未知")
			    		$("#service_status_operate").hide()
			    		$("#onekey_deploy").hide();
			    		$("#service_status").html("未知")
			    		$("#service_status_operate").hide()
			    		$("#service_visitor").hide();
			    		$("#service_status").attr("class","badge badge-sm label-success")
						$("#multi_ports").hide()
		    		  }
		    	  }
    		  },
    		  error: function(){
    			//swal("系统异常");
      	  	}
       })
    }
	
	function getLog(){
		$.ajax({
       	  type: "GET",
    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/log",
    		  data: "action=operate",
    		  cache: false,
    		  beforeSend: function(xhr, settings){
    		      var csrftoken = $.cookie('csrftoken');
    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    		  },
    	  	  success: function(msg) {
    	  		var dataObj = msg;
    	  		var showlog=""
   	  			var logList = dataObj["log"]
   	  			if(typeof(logList) !="undefined"){
   	  				for(var i=0;i<logList.length;i++){
    	  				var log = logList[i]
    	  				var tmpLog = log["create_time"]+" @"+log["user_id"] +" "+log["desc"]
       					if(log["status"] == "end"){
       						tmpLog = tmpLog+" 用时"+log["cost_time"]+"s";
       					}
    	  				tmpLog = "<label>"+tmpLog+"</label><p id='compile_"+log["event_id"]+"' style='display: none;'></p>"
    	  				tmpLog = "<div id='event_"+log["event_id"]+"'>"+tmpLog+"</div>"
    	  				showlog =showlog + tmpLog
    	  			}
    	  			$("#keylog").html(showlog)
   	  			}
    		  },
    		  error: function(){
    			//swal("系统异常");
      	  	}
       })
	}
	
	$(document).ready(function () {
    	checkStatus();
    	getLog(); 
    	setInterval("checkStatus()", 6000);
    	extPushWebSocketClient.prototype = {
   			onMessage : function(msg) {
   				if(typeof(msg) !="undefined"){
       				var msgs = msg.split(":")
       				if(msgs[0].trim()=="deploy"){
       					var newMsg = msg.substr(7)
       					log = eval("(" + newMsg + ")");  
       					var showlog = log["create_time"]+" @"+log["user_id"] +" "+log["desc"]
       					if(log["status"] == "end"){
       						showlog = showlog+" 用时"+log["cost_time"]+"s";
       					}
						showlog = "<label>"+showlog+"</label><p id='compile_"+log["event_id"]+"' style='display: none;'></p>"
						if($("#event_"+log["event_id"]).length>0){
							$("#event_"+log["event_id"]).html(showlog)
						}else{
							showlog = "<div id='event_"+log["event_id"]+"'>"+showlog+"</div>"
							var arr=$("#keylog").html().split('<br>');
	       					if(arr[0].trim() != newMsg.trim()){
	       						var finalMsg = showlog + $("#keylog").html()
	           					$("#keylog").html(finalMsg)
	       					}
						}
       				}else if(msgs[0].trim()=="compile"){
       					var event_id= msgs[1]
       					var newMsg = msg.substr(25)
       					var arr=$("#compile_"+event_id+"").html().split('<br>');
   						if(arr[0].trim() != newMsg.trim()){
   							var finalMsg = newMsg +"<br/>"+ $("#compile_"+event_id+"").html()
           					$("#compile_"+event_id+"").html(finalMsg)
           					$("#compile_"+event_id+"").show();
   						}
       				}
   				}
   			}
    	}
   		var connect = new extPushWebSocketConnect('{{websocket_uri}}');
   		connect.init(new extPushWebSocketClient(),service_id, "submsg", "submsg","123456789","987654321");
    });

	function do_logshow(event_id,deploy_version){
    	if($("#showlog_"+event_id+"").html() == "显示构建日志"){
    		if($("#compile_"+event_id+"").html() == ""){
    			$("#compile_"+event_id+"").show();
    			$.ajax({
       	       	  type: "GET",
       	    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/log",
       	    		  data: "action=compile&event_id="+event_id,
       	    		  cache: false,
       	    		  beforeSend: function(xhr, settings){
       	    		      var csrftoken = $.cookie('csrftoken');
       	    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
       	    		  },
       	    	  	  success: function(msg) {
       	    	  		var dataObj = msg;
       	    	  		var log = dataObj["log"];
       	    	  		$("#compile_"+event_id+"").html(log)
       	    	  		$("#showlog_"+event_id+"").html("隐藏构建日志")
       	    		  },
       	    		  error: function(){
       	    			//swal("系统异常");
       	      	      }
          	    })
    		}else{
    			$("#compile_"+event_id+"").show();
    			$("#showlog_"+event_id+"").html("隐藏构建日志")
    		}        		
		}else{
			$("#compile_"+event_id+"").hide();
			$("#showlog_"+event_id+"").html("显示构建日志")
		}        	
    }
    
    function do_rollback(event_id,deploy_version){
    	swal({
    		title : "确定恢复当前版本吗？",
    		type : "warning",
    		showCancelButton : true,
    		confirmButtonColor : "#DD6B55",
    		confirmButtonText : "确定",
    		cancelButtonText : "取消",
    		closeOnConfirm : false,
    		closeOnCancel : false
    	}, function(isConfirm) {
    		if (isConfirm) {
    			$.ajax({
            		type : "POST",
            		url : "/ajax/{{tenantName}}/{{tenantServiceInfo.service_alias}}/manage",
            		data : "event_id=" + event_id + "&action=rollback&deploy_version="+deploy_version,
            		cache : false,
            		beforeSend : function(xhr, settings) {
            			var csrftoken = $.cookie('csrftoken');
            			xhr.setRequestHeader("X-CSRFToken", csrftoken);
            		},
            		success : function(msg) {
            			var dataObj = msg
            			if (dataObj["status"] == "success") {
            				swal("操作成功")
            			} else if (dataObj["status"] == "often") {
            				swal("操作正在进行中，请稍后")
            			} else if (dataObj["status"] == "owed") {
            				swal("余额不足请及时充值")
            			} else if (dataObj["status"] == "expired") {
							swal("试用已到期")
						} else if (dataObj["status"] == "over_memory") {
            				swal("资源已达上限，不能升级")
            			} else if (dataObj["status"] == "over_money") {
            				swal("余额不足，不能升级")
            			} else {
            				swal("操作失败")
            			}
            		},
            		error : function() {
            			swal("系统异常");
            			$("#operate_"+service_id).removeAttr("disabled")
            		}
            	});
    		} else {
    			swal.close();
    		}
    	});
    }
    
    function join_container(){
        $.ajax({
            type : "GET",
            url : "/ajax/{{tenantName}}/{{tenantServiceInfo.service_alias}}/docker",
            cache : false,
            beforeSend : function(xhr, settings) {
                var csrftoken = $.cookie('csrftoken');
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
            success : function(dataObj) {
                var msg=""
                var tindex=1
                for(var key in dataObj){
                    if(key != "split"){
                        msg+="<tr>";
                        msg+="<td>container:";
                        msg+=tindex;
                        msg+="</td>"
                        msg+="<td><a href='javascript:void(0);'  onclick='join_in(\""+key+"\",\""+dataObj[key]+"\")'> 进入控制台</a></td>"
                        msg+="</tr>";
                        tindex+=1;
                    }
                } 
                if(msg!=""){
                    $("#cur_container_content").html(msg)
                }
            },
            error : function() {
                swal("系统异常");
            }
        });
    }
    
    function join_in(ctn_id,host_ip){
        if(ctn_id !="" && host_ip !=""){
            $.ajax({
                type : "POST",
                url : "/ajax/{{tenantName}}/{{tenantServiceInfo.service_alias}}/docker",
                data : "c_id=" + ctn_id + "&h_id="+host_ip,
                cache : false,
                beforeSend : function(xhr, settings) {
                    var csrftoken = $.cookie('csrftoken');
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                },
                success : function(dataObj) {
                    if (dataObj["success"]) {
                      window.location.href="/apps/{{tenantName}}/{{tenantServiceInfo.service_alias}}/docker/"
                    }else{
                       swal("操作失败")
                    }
                },
                error : function() {
                    swal("系统异常");
                }
            });
        }
    }

    function visit() {
		var port = $("#multi_ports").val();

		var url = "http://"+port+".{{serviceAlias}}.{{tenantName}}{{wild_domain}}{{http_port_str}}"
		if(port==""||port == null){
			url = "http://{{serviceAlias}}"+".{{tenantName}}{{wild_domain}}{{http_port_str}}"
		}
		window.open(url)
	}

	function showStatus() {
		$.ajax({
			type: "GET",
			url: "/ajax/{{tenantName}}/{{tenantServiceInfo.service_alias}}/container-stats",
			cache: false,
			dataType: 'json',
			beforeSend: function (xhr, settings) {
				var csrftoken = $.cookie('csrftoken');
				xhr.setRequestHeader("X-CSRFToken", csrftoken);
			},
			success: function (dataObj) {
				var list = dataObj.tenant_service_stats;
				var content = "";
				$("#container_stats").html(content);
				for(var i=0;i<list.length;i++){
					var index = i+1;
					content += "<tr><td> 容器" + index + "</td>>" + "<td>" + list[i].used_memory + " M</td>" + "<td>" + list[i].memory_limit + " M</td>" + "<td>" + list[i].memory_percent + " %</td>" + "<td>" + list[i].cpu_percent + " %</td></tr>";
				}
				$("#container_stats").append(content);
			},
			error: function () {
				swal("容器信息获取异常");
			}
		});
	}
</script>

