{% extends 'www/raster.html' %}
{% load i18n %}
{% load goodrain_extras %}
{% load static %}
{% block extracss %}
{{ block.super }}
<link rel="stylesheet" href='{% static "www/css/grouping.css" %}' />
{% endblock %}
{% block extrajs %}
<script src='{% static "www/js/group.js" %}'></script>
{% endblock %}

{% block main-content %}
<input type="hidden" id="group_id_input" value="{{group_id}}"/>
<section class="wrapper site-min-height">
	<section class="panel">
	<!-- main start  -->
		<!-- top 分组 -->
		<div class="clearfix" id="app-group"   data-tenantName="{{tenantName}}">
			<p data-group="{{group_id}}" class="pull-left group-tit" id="group-tit">{{group_name}}</p>
			<!--
			<select>
				<option value="0">全部应用</option>
				{% for group in groups %}
				<option value="{{group.ID}}">{{group.group_name}}</option>
				{% endfor %}
				<option value="-1">未分组</option>
			</select>
			-->
			
			<!--
			<p class="pull-right search-icon"><input type="text" name="" value="" id="search"></p>
			-->
			<!--
			<div class="group-btn-box">
				<p class="group-btn">
					<a href="javascript:;" id="imgbtn" class="imgbtn sed"></a>
					<a href="javascript:;" id="tabbtn" class="tabbtn"></a>
					<a href="javascript:;" id="setbtn" class="setbtn"></a>
				</p>
				<p class="group-set-box">
					{% if group_id != -1  %}
					<a href="javascript:;" id="revise-groupname">修改组名</a>
					<a href="javascript:;" id="reomve-groupname">删除当前组</a>
					{% endif %}
					<a href="javascript:;" id="add-groupname">新增组</a>
				</p>
			</div>
			-->
			{% if group_id != -1  %}
			<div class="group-btn-box">
				<p class="group-btn">
					<a href="javascript:;" id="imgbtn" class="imgbtn sed"></a>
					<a href="javascript:;" id="tabbtn" class="tabbtn"></a>
					<a href="javascript:;" id="setbtn" class="setbtn"></a>
				</p>
				<p class="group-set-box">
					<span class="uparrow"></span>
					<span class="uparrowinner"></span>
					<a href="javascript:;" id="revise-groupname">修改组名</a>
					<a href="javascript:;" id="reomve-groupname">删除当前组</a>
					<a href="javascript:;" id="add-groupname">新增组</a>
				</p>
			</div>
			{% else %}
			<a href="javascript:;" id="add-groupname" class="pull-right greenbtn">新增组</a>
			{% endif %}
			<!-- -->
		</div>
		<!-- top 结束 -->
		<!-- biaoge start -->
		<section id="tabBox" class="content-tab" style="display: none;">
			<!-- tab start -->
			<table>
				<thead>
					<tr>
						<th class="bs-checkbox fn-SelectAll"><input type="checkbox" name="SelectAll" value=""></th>
						<th>应用名</th>
						<th>版本</th>
						<th>类型 </th>
						<th>分组</th>
						<th>内存</th>
						<th>状态</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody id="tab-box">
					{% for item in tenantServiceList %}
					<tr id="panel" class="tabline" data-group="{{item.group_id}}" data-id="{{item.service_id}}">
						<!-- 复选框 -->
						<td class="bs-checkbox fn-SelectItem">
							<input name="SelectItem" type="checkbox"  type="checkbox" value="{{item.service_id}}" service_alias="{{item.service_alias}}"/>
						</td>
						<!-- 应用名  -->
						<td>
							<h4>
								<a href="/apps/{{tenantName}}/{{item.service_alias}}/detail/" style="color:#28cb75; font-size: 16px;">{{item.service_cname}}</a>
							</h4>
						</td>
						<!-- 版本 -->
						<td>
							{% if item.category == "application" %}
								{{item.deploy_version}}
							{% else %}
								{{item.version}}					
							{% endif %}
						</td>
						<!-- 类型 -->
						<td>{{item.service_type}}</td> 
						<!-- 分组 -->
						{% with cur_group=serviceGroupIdMap|mkey:item.service_id %}
						<td class="choose-group-box fn-choose-group">
							{% with groupName=serviceGroupNameMap|mkey:cur_group %}
								{% if groupName %}
									<span class="fn-name">{{groupName}}</span>
								{% else %}
									<span class="fn-name">未分组</span>
								{% endif %}
							{% endwith %}


							<div class="fn-show-select  choose-layer">
								<select>

									{% for group in groupList %}

										<option value="{{group.ID}}" >{{group.group_name}}</option>

									{% endfor %}

									<option value="-1">未分组</option>
								</select>
								<button class="fn-groupname-sure btn btn-success" data-id="{{item.service_id}}" style="padding: 0 2px;"><i class="fa fa-check"></i></button>
								<button class="fn-groupname-close btn btn-danger" style="padding: 0 4px;"><i class="fa fa-times"></i></button>
							</div>
						</td>
						{% endwith %}
						<!-- 内存  -->
						<td id="service_memory_{{item.service_id}}">0M</td>
						<!-- 状态 -->
						<td>
							<span id="service_status_{{item.service_id}}">未知</span>
						</td>
						<!-- 操作 -->
						<td>
							{% if item.category == "application" %}
							<button type="button" class="btn greenbtn"
								id="button_{{item.service_id}}"
								onclick="service_my_oneKeyDeploy('application','{{item.service_alias}}','{{tenantName}}','no');">
								部署
							</button>
							{% endif %}
							<button class="btn redbtn" data{{item.service_id}}="0"
								onclick="service_my_onOperation('{{item.service_id}}','{{item.service_alias}}','{{tenantName}}');"
								id="operate_{{item.service_id}}">
								<i id="operate_inner_{{item.service_id}}">关闭</i>
							</button>
							<!--
							<button class="btn  greenbtn" onclick="window.location.href=href='/apps/{{tenantName}}/{{item.service_alias}}/detail/' ">设置</button>
							-->
						</td>
					 </tr>
					{% endfor %}
				</tbody>
			</table>
			<!-- tab end -->
			<!-- Mass deployment Start -->
			<div class="clearfix numbers-box" id="nums-app">
				<p id="app-numbers">已选择<span>0</span>个应用</p>
				<button id="batchStart" class="btn greenbtn">批量启动</button>
				<button id="batchEnd" class="btn redbtn">批量关闭</button>
				<button id="newStart" class="btn greenbtn">批量重新部署</button>
				<button id="groupShare" class="btn greenbtn">分享</button>
			</div>
			<!-- Mass deployment End-->
		</section>
		<!-- biaoge end-->
		<!-- tu start -->
		<section id="imgBox" class="content-tab">
			<div id="svg-box"></div>
		</section>
		<!-- tu end -->
	<!-- main end -->
	</section>
	<script>
	    function checkStatus(){
	    	var servcieList=$(".tabline");
	    	var curLength=servcieList.length;
    		if(curLength >0 ){
    			$.ajax({
   		       	  type: "GET",  
   		    		  url: "/ajax/{{tenantName}}/serviceinfo", 		  
   		    		  cache: false,
   		    		  beforeSend: function(xhr, settings){  
   		    		      var csrftoken = $.cookie('csrftoken');  
   		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);  
   		    		  },  
   		    	  	  success: function(msg) {
   		    	  		  var dataObj=msg;
   		    	  		  totalM =0; 
		    		  	  for(var o in dataObj){
			    		  	  var obj=dataObj[o]
			    		  	  if(obj["status"]=="running"){
			    		  		 $("#service_status_"+o).html("运行中")
			    		  		 //$("#service_status_"+o).attr("class","label label-success label-mini")
			    		  		 //$("#button_"+o).attr("class","btn btn-shadow btn-info")
			    		  		 $("#button_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).removeAttr("disabled")
			    		  		 //$("#operate_"+o).attr("class","btn btn-danger")
								 //$("#operate_inner_"+o).attr("class","fa fa-power-off")
								 $("#operate_"+o).attr("class","btn redbtn")
								 $("#operate_inner_"+o).html("关闭");
								 $("#operate_"+o).attr("data"+o,"stop")	
							  }else if(obj["status"]=="starting"){
                                 $("#service_status_"+o).html("启动中")
                                 //$("#service_status_"+o).attr("class","label label-success label-mini")
                                 //$("#button_"+o).attr("class","btn btn-shadow btn-info")
                                 $("#button_"+o).removeAttr("disabled")
                                 $("#operate_"+o).removeAttr("disabled")
                                 //$("#operate_"+o).attr("class","btn btn-danger")
                                 //$("#operate_inner_"+o).attr("class","fa fa-power-off")
                                 $("#operate_"+o).attr("class","btn redbtn")
								 $("#operate_inner_"+o).html("关闭");
                                 $("#operate_"+o).attr("data"+o,"stop") 
					    	  }else if(obj["status"]=="unusual"){
					    		 $("#service_status_"+o).html("运行异常")
					    		 //$("#service_status_"+o).attr("class","label label-danger label-mini")
					    		 $("#button_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).removeAttr("disabled")
			    		  		 //$("#operate_"+o).attr("class","btn btn-danger")
								 //$("#operate_inner_"+o).attr("class","fa fa-power-off")
								 $("#operate_"+o).attr("class","btn redbtn")
								 $("#operate_inner_"+o).html("关闭");
						      }else if(obj["status"]=="closed" || obj["status"]=="owed" || obj["status"]=="expired"){
					    		 $("#service_status_"+o).html("已关闭")
					    		 if(obj["status"]=="closed"){
					    			 $("#service_status_"+o).html("已关闭")
								 }else{
				    		  		 $("#service_status_"+o).html("余额不足已关闭")
				    		  	 }
					    		 //$("#service_status_"+o).attr("class","label label-danger label-mini")			    		 
					    		 $("#button_"+o).attr('disabled',"true")
						    	 $("#operate_"+o).removeAttr("disabled")
					    		 //$("#operate_"+o).attr("class","btn btn-success")
								 //$("#operate_inner_"+o).attr("class","fa fa-play")
								 //$("#operate_"+o).attr("class","btn btn-success")
								 //$("#operate_inner_"+o).attr("class","fa fa-play")
								 $("#operate_"+o).attr("class","btn greenbtn")
								 $("#operate_inner_"+o).html("启动");
								 $("#operate_"+o).attr("data"+o,"restart")
						      }else if(obj["status"]=="undeploy"){
						    	 $("#service_status_"+o).html("未部署")	
						    	 //$("#service_status_"+o).attr("class","label label-info label-mini")				    		 
						    	 $("#button_"+o).removeAttr("disabled")
						    	 $("#operate_"+o).attr('disabled',"true")
						    	 //$("#operate_"+o).attr("class","btn btn-danger")
								 //$("#operate_inner_"+o).attr("class","fa fa-power-off")
								 $("#operate_"+o).attr("class","btn redbtn")
								 $("#operate_inner_"+o).html("关闭");
						      }else{
						    	 $("#service_status_"+o).html("未知")
						    	 //$("#service_status_"+o).attr("class","label label-warning label-mini")
						    	 $("#button_"+o).attr('disabled',"true")
						    	 $("#operate_"+o).attr('disabled',"true")
							  }
			    		   }
   		    		  },
   		    		  error: function(){
   		    			//swal("系统异常");
   		      	  	}
   		       })
        	}
	    }
	    
	    function checkTenantsStorage(){
	    	var servcieList=$("#panel")
	    	var curLength=servcieList.length;
    		if(curLength >0 ){
    			$.ajax({
   		       	  type: "GET",  
   		    		  url: "/ajax/{{tenantName}}/tenant-disk", 		  
   		    		  cache: false,
   		    		  beforeSend: function(xhr, settings){  
   		    		      var csrftoken = $.cookie('csrftoken');  
   		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
   		    		  },
   		    	  	  success: function(msg) {
   		    	  		  var dataObj=msg;
   		    	  		  totalM =0; 
   		    	  		  var service_ids = dataObj["service_ids"]
		    		  	  for(var i=0;i< service_ids.length;i++){
		    		  		  var o = service_ids[i]
			    		  	  running_memory = 0
			    			  if(dataObj[o+"_running_memory"] != undefined){
			    				  running_memory = dataObj[o+"_running_memory"];
			    			  }
			    			  storage_memory = 0
			    			  if(dataObj[o+"_storage_memory"] != undefined){
			    			      storage_memory = dataObj[o+"_storage_memory"];
			    			  }
			    			  if($("#service_status_"+o).html() == "运行中"){
			    				 $("#service_memory_"+o).html((running_memory + storage_memory)+"M")
			    				 totalM = totalM + running_memory + storage_memory
			    			  }else if($("#service_status_"+o).html() == "部署中"){
			    				 $("#service_memory_"+o).html((running_memory + storage_memory)+"M")
			    				 totalM = totalM + running_memory + storage_memory
			    			  }else{
			    				 $("#service_memory_"+o).html(storage_memory+"M")
			    				 totalM = totalM + storage_memory
			    			  }
			    		   }
   		    		  },
   		    		error: function(){
   		    			//swal("系统异常");
   		      	  	}
   		       })
        	}
	    }

	    $(document).ready(function () {  
	    	checkStatus()
	    	setTimeout("checkTenantsStorage()", 1000);
            setInterval("checkStatus()", 15000);
	    	setInterval("checkTenantsStorage()", 30000);
        });

	
    </script>
</section>
{% endblock %}