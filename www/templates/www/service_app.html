{% extends 'www/raster.html' %}
{% load i18n %}
{% load static %}
{% block extracss %}
{{ block.super }}
<link rel="stylesheet" href='{% static "www/css/grouping.css" %}' />
{% endblock %}
{% block extrajs %}
<script src='{% static "www/js/group.js" %}'></script>
{% endblock %}

{% block main-content %}
<section class="wrapper site-min-height">
	<section class="panel">
	<!-- main start  -->
		<!-- top 分组 -->
		<div class="clearfix" id="app-group"   data-tenantName="{{tenantName}}">
			{% for group in groups %}
			<p data-group="{{group.ID}}" class="pull-left group-tit">{{group.group_name}}</p>
			{% endfor %}
			<p data-group="-1" class="pull-left group-tit">分组</p>
			<!--
			<select>
				<option value="0">全部应用</option>
				{% for group in groups %}
				<option value="{{group.ID}}">{{group.group_name}}</option>
				{% endfor %}
				<option value="-1">未分组</option>
			</select>
			-->
			<a href="javascript:;" id="revise-groupname" class="btn btn-success">修改组名</a>
			<a href="javascript:;" id="reomve-groupname" class="btn btn-danger">删除当前组</a>
			<a href="javascript:;" id="add-groupname" class="btn btn-success">新增组</a>
			<!--
			<p class="pull-right search-icon"><input type="text" name="" value="" id="search"></p>
			-->
		</div>
		<!-- top 结束 -->
		<!-- tab start -->
		<table class="table table-striped table-hover">
			<thead>
				<tr>
					<!--<th class="bs-checkbox fn-SelectAll"><input type="checkbox" name="SelectAll" value=""></th>-->
					<th>应用名</th>
					<th>版本</th>
					<th>类型 </th>
					<th>分组</th>
					<th>内存</th>
					<th>状态</th>
					<th><i class="fa fa-edit"></i> 操作</th>
				</tr>
			</thead>
			<tbody id="tab-box">
				{% for item in tenantServiceList %}
				<tr id="panel" class="tabline" data-group="{{item.group_id}}" data-id="{{item.service_id}}">
					<!-- 复选框 -->
					<!--<td class="bs-checkbox fn-SelectItem">-->
						<!--<input name="SelectItem" type="checkbox"  type="checkbox" value="{{item.service_id}}" />-->
					<!--</td>-->
					<!-- 应用名  -->
					<td>
						<h4>
							<a href="/apps/{{tenantName}}/{{item.service_alias}}/detail/">{{item.service_cname}}</a>
						</h4>
					</td>
					<!-- 版本 -->
					<td>
						{% if item.category == "application" %}
							{{item.deploy_version}}
						{% else %}
							{{item.version}}					
						{% endif %}
					</td>
					<!-- 类型 -->
					<td>{{item.service_type}}</td> 
					<!-- 分组 -->
					<td class="choose-group-box fn-choose-group">
						<span class="fn-name">{{item.group_name}}</span>
						<div class="fn-show-select  choose-layer">
							<select>
								{% for group in groups %}
								<option value="{{group.ID}}">{{group.group_name}}</option>
								{% endfor %}
								<option value="-1">未分组</option>
							</select>
							<button class="fn-groupname-sure btn btn-success" data-id="{{item.service_id}}" >√</button>
							<button class="fn-groupname-close btn btn-danger">×</button>
						</div>
					</td>
					<!-- 内存  -->
					<td id="service_memory_{{item.service_id}}">0M</td>
					<!-- 状态 -->
					<td>
						<span class="label label-success label-mini"
						id="service_status_{{item.service_id}}">未知</span>
					</td>
					<!-- 操作 -->
					<td>
						{% if item.category == "application" %}
						<button type="button" class="btn btn-shadow btn-info "
							id="button_{{item.service_id}}"
							onclick="service_oneKeyDeploy('application','{{item.service_alias}}','{{tenantName}}','no');">
							<i class="fa fa-refresh"></i>部署
						</button>
						{% endif %}
						<button class="btn btn-danger" data{{item.service_id}}="0"
							onclick="service_my_onOperation('{{item.service_id}}','{{item.service_alias}}','{{tenantName}}');"
							id="operate_{{item.service_id}}">
							<i class="fa fa-power-off "
								id="operate_inner_{{item.service_id}}"></i>
						</button>
						<button class="btn btn-primary"
							onclick="window.location.href=href='/apps/{{tenantName}}/{{item.service_alias}}/detail/' ">
							<i class="fa fa-gear"></i>
						</button>
					</td>
				 </tr>
				{% endfor %}
			</tbody>
		</table>
		<!-- tab end -->
		<!-- Mass deployment Start -->
		<div class="clearfix numbers-box" id="nums-app">
			<p id="app-numbers">已选择<span>0</span>个应用</p>-->
			<button id="batchStart" class="btn btn-success">批量启动</button>
			<button id="batchEnd" class="btn btn-danger">批量停止</button>
			<button id="newStart" class="btn btn-info">批量重新部署</button>
		</div>
		<!-- Mass deployment End-->
	<!-- main end -->
	</section>
	<script>
	    function checkStatus(){
	    	var servcieList=$(".tabline");
	    	var curLength=servcieList.length;
    		if(curLength >0 ){
    			$.ajax({
   		       	  type: "GET",  
   		    		  url: "/ajax/{{tenantName}}/serviceinfo", 		  
   		    		  cache: false,
   		    		  beforeSend: function(xhr, settings){  
   		    		      var csrftoken = $.cookie('csrftoken');  
   		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);  
   		    		  },  
   		    	  	  success: function(msg) {
   		    	  		  var dataObj=msg;
   		    	  		  totalM =0; 
		    		  	  for(var o in dataObj){
			    		  	  var obj=dataObj[o]
			    		  	  if(obj["status"]=="running"){
			    		  		 $("#service_status_"+o).html("运行中")
			    		  		 $("#service_status_"+o).attr("class","label label-success label-mini")
			    		  		 $("#button_"+o).attr("class","btn btn-shadow btn-info")
			    		  		 $("#button_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).attr("class","btn btn-danger")
								 $("#operate_inner_"+o).attr("class","fa fa-power-off")
								 $("#operate_"+o).attr("data"+o,"stop")	
							  }else if(obj["status"]=="starting"){
                                 $("#service_status_"+o).html("启动中")
                                 $("#service_status_"+o).attr("class","label label-success label-mini")
                                 $("#button_"+o).attr("class","btn btn-shadow btn-info")
                                 $("#button_"+o).removeAttr("disabled")
                                 $("#operate_"+o).removeAttr("disabled")
                                 $("#operate_"+o).attr("class","btn btn-danger")
                                 $("#operate_inner_"+o).attr("class","fa fa-power-off")
                                 $("#operate_"+o).attr("data"+o,"stop") 
					    	  }else if(obj["status"]=="unusual"){
					    		 $("#service_status_"+o).html("运行异常")
					    		 $("#service_status_"+o).attr("class","label label-danger label-mini")
					    		 $("#button_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).removeAttr("disabled")
			    		  		 $("#operate_"+o).attr("class","btn btn-danger")
								 $("#operate_inner_"+o).attr("class","fa fa-power-off")
						      }else if(obj["status"]=="closed" || obj["status"]=="owed" || obj["status"]=="expired"){
					    		 $("#service_status_"+o).html("已关闭")
					    		 if(obj["status"]=="closed"){
					    			 $("#service_status_"+o).html("已关闭")
								 }else{
				    		  		 $("#service_status_"+o).html("余额不足已关闭")
				    		  	 }
					    		 $("#service_status_"+o).attr("class","label label-danger label-mini")			    		 
					    		 $("#button_"+o).attr('disabled',"true")
						    	 $("#operate_"+o).removeAttr("disabled")
					    		 $("#operate_"+o).attr("class","btn btn-success")
								 $("#operate_inner_"+o).attr("class","fa fa-play")
								 $("#operate_"+o).attr("class","btn btn-success")
								 $("#operate_inner_"+o).attr("class","fa fa-play")
								 $("#operate_"+o).attr("data"+o,"restart")
						      }else if(obj["status"]=="undeploy"){
						    	 $("#service_status_"+o).html("未部署")	
						    	 $("#service_status_"+o).attr("class","label label-info label-mini")				    		 
						    	 $("#button_"+o).removeAttr("disabled")
						    	 $("#operate_"+o).attr('disabled',"true")
						    	 $("#operate_"+o).attr("class","btn btn-danger")
								 $("#operate_inner_"+o).attr("class","fa fa-power-off")
						      }else{
						    	 $("#service_status_"+o).html("未知")
						    	 $("#service_status_"+o).attr("class","label label-warning label-mini")
						    	 $("#button_"+o).attr('disabled',"true")
						    	 $("#operate_"+o).attr('disabled',"true")
							  }
			    		   }
   		    		  },
   		    		  error: function(){
   		    			//swal("系统异常");
   		      	  	}
   		       })
        	}
	    }
	    
	    function checkTenantsStorage(){
	    	var servcieList=$("#panel")
	    	var curLength=servcieList.length;
    		if(curLength >0 ){
    			$.ajax({
   		       	  type: "GET",  
   		    		  url: "/ajax/{{tenantName}}/tenant-disk", 		  
   		    		  cache: false,
   		    		  beforeSend: function(xhr, settings){  
   		    		      var csrftoken = $.cookie('csrftoken');  
   		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
   		    		  },
   		    	  	  success: function(msg) {
   		    	  		  var dataObj=msg;
   		    	  		  totalM =0; 
   		    	  		  var service_ids = dataObj["service_ids"]
		    		  	  for(var i=0;i< service_ids.length;i++){
		    		  		  var o = service_ids[i]
			    		  	  running_memory = 0
			    			  if(dataObj[o+"_running_memory"] != undefined){
			    				  running_memory = dataObj[o+"_running_memory"];
			    			  }
			    			  storage_memory = 0
			    			  if(dataObj[o+"_storage_memory"] != undefined){
			    			      storage_memory = dataObj[o+"_storage_memory"];
			    			  }
			    			  if($("#service_status_"+o).html() == "运行中"){
			    				 $("#service_memory_"+o).html((running_memory + storage_memory)+"M")
			    				 totalM = totalM + running_memory + storage_memory
			    			  }else if($("#service_status_"+o).html() == "部署中"){
			    				 $("#service_memory_"+o).html((running_memory + storage_memory)+"M")
			    				 totalM = totalM + running_memory + storage_memory
			    			  }else{
			    				 $("#service_memory_"+o).html(storage_memory+"M")
			    				 totalM = totalM + storage_memory
			    			  }
			    		   }
   		    		  },
   		    		error: function(){
   		    			//swal("系统异常");
   		      	  	}
   		       })
        	}
	    }

	    $(document).ready(function () {  
	    	checkStatus()
	    	setTimeout("checkTenantsStorage()", 1000);
            setInterval("checkStatus()", 15000);
	    	setInterval("checkTenantsStorage()", 30000);
        });

	
    </script>
</section>
{% endblock %}