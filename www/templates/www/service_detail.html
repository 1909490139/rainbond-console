{% extends 'www/raster.html' %}

{% load i18n %}

{% load goodrain_extras %}


{% block main-content %}

{% if tenantServiceInfo %}
<section class="wrapper">
<section class="panel">
      <header class="panel-heading tab-bg-dark-navy-blue ">
      <ul class="nav nav-tabs" id ="nav-tabs">
        <li  class="active"><a href="#deployed"  data-toggle="tab">概览</a></li>
        {% if tenantServiceInfo.category == "application" or tenantServiceInfo.category == "manager" or tenantServiceInfo.category == "app_publish" %}
        	<li class="" ><a href="#relations"  data-toggle="tab">依赖</a></li>
        {% endif  %}
        {% if tenant.pay_type != 'free' %}
          {% if show_graph %}
          <li class="" ><a href="#statistic"  data-toggle="tab">监控</a></li>
          {% else %}
          <li class="" ><a href="{{ request.path }}?show_graph=yes">监控</a></li>
          {% endif %}
        {% endif %}
        <li class=""><a href="#log"  data-toggle="tab">日志</a></li>
        <li class=""><a href="#settings"  data-toggle="tab">高级</a></li>
        <!--{% ifequal tenantServiceInfo.category "application" %}
        <li class="nav-tabs-oklastli"><b>git</b><input type="text" value="git@code.goodrain.com:app/{{tenantName}}_{{serviceAlias}}.git" placeholder="http://code.goorain.com/username" class="form-control"><span class="fa fa-clipboard"></span></li>
        {% endifequal  %}-->
      </ul>
      </header>

      <div class="panel-body">
      <div class="tab-content">
        {% include 'www/include/tab_deployed.html' %}
        {% include 'www/include/tab_relations.html' %}
        
        {% include 'www/include/tab_statistic.html' %}
        {% include 'www/include/tab_log.html' %}

        {% include 'www/include/tab_settings.html' %}
      </div>
      </div>

    <script>
    {% if show_graph %}
      $('div.tab-pane').removeClass('active');
      $('ul.nav-tabs li').removeClass('active');
      $('#statistic').addClass('active');
      $('ul.nav-tabs a[href="#statistic"]').parent('li').addClass('active');
    {% endif %}

    String.prototype.trim = function() {
	    return this.replace(/(^\s*)|(\s*$)/g, "");
	}
      var service_id='{{tenantServiceInfo.service_id}}'
      var serviceAlias = $('#mytags').attr('service');
	    function checkStatus(){
		    if(service_id!=""){
		    	$.ajax({
		       	  type: "GET",
		    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/detail/",
		    		  cache: false,
		    		  beforeSend: function(xhr, settings){
		    		      var csrftoken = $.cookie('csrftoken');
		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
		    		  },
		    	  	  success: function(msg) {
		    	  		  var obj=msg;
			    	  	  if(obj["status"]!="failure"){
			    		  	  if(obj["status"]=="running"){
			    		  		$("#service_status_value").val("stop")
			    		  		$("#font"+service_id).html("关闭")
			    		  		$("#service_status_operate").show()
			    		  		$("#onekey_deploy").show()
			    		  		$("#onekey_deploy").removeAttr("disabled")
			    		  		$("#service_status").html("运行中")
			    		  		$("#service_status_operate").show()
			    		  		$("#service_visitor").show()
			    		  		$("#service_status").attr("class","badge badge-sm label-success")
				    		  }else if(obj["status"]=="unusual"){
				    			$("#service_status_value").val("")
				    		  	$("#font"+service_id).html("启动")
				    		  	$("#service_status_operate").show()
				    		  	$("#onekey_deploy").show();
				    		  	$("#service_status").html("运行异常")
				    		    $("#service_status_operate").show()
				    			$("#service_visitor").show()
				    			$("#service_status").attr("class","badge badge-sm label-danger")
				    		  }else if(obj["status"]=="closed" || obj["status"]=="owed"){
				    			$("#service_status_value").val("restart")
				    		  	$("#font"+service_id).html("启动")
				    		  	$("#service_status_operate").show()
				    		  	$("#onekey_deploy").show()
				    		  	$("#onekey_deploy").removeAttr("disabled")
				    		  	if(obj["status"]=="closed"){
				    		  		$("#service_status").html("已关闭")
				    		  		$("#service_status").attr("class","badge badge-sm label-success")
				    		  	}else{
				    		  		$("#service_status").html("余额不足已关闭")
				    		  		$("#service_status").attr("class","badge badge-sm label-danger")
				    		  	}
				    		  	$("#service_status_operate").show()
				    		  	$("#service_visitor").hide();
				    		  }else if(obj["status"]=="undeploy"){
				    			$("#service_status_value").val("")
				    			$("#font"+service_id).html("未部署")
				    			$("#service_status_operate").hide();
				    			$("#onekey_deploy").show()
				    			$("#onekey_deploy").removeAttr("disabled")
				    			$("#service_status").html("未部署")
				    			$("#service_status_operate").hide();
				    			$("#service_visitor").hide();
				    			$("#service_status").attr("class","badge badge-sm label-success")
				    		  }else{
				    			$("#service_status_value").val("")
					    		$("#font"+service_id).html("未知")
					    		$("#service_status_operate").hide()
					    		$("#onekey_deploy").hide();
					    		$("#service_status").html("未知")
					    		$("#service_status_operate").hide()
					    		$("#service_visitor").hide();
					    		$("#service_status").attr("class","badge badge-sm label-success")
				    		  }
				    	  }
		    		  },
		    		  error: function(){
		    			//swal("系统异常");
		      	  	}
		       })
			}
	    }
		
	    var setIntertimmer
	    
        $(document).ready(function () {
        	checkStatus();
        	getLog('operate');
        	getLog('service');
        	
        	//setTimeout("getServiceNetDisk()", 1000);
        	setInterval("checkStatus()", 5000);
            //setInterval("getServiceNetDisk()", 30000);
            
            var mapping = $("#create_port_mapping").val()
            if(mapping != undefined){
            	getMappingPort()
            	setIntertimmer = setInterval("getMappingPort()", 3000);
            }
            
            tabObj = $('#nav-tabs a')
            curTab= "#{{tab_index}}"
            for(var i=0;i<tabObj.length;i++){
            	var tabc = $('#nav-tabs a:eq('+i+')').attr("href")
            	if (tabc == curTab){
            		$('#nav-tabs a:eq('+i+')').tab('show')
            		break;
            	}
            }
            
            $( "#protocol" ).change(function() {
            	service_protocol('outer','change','{{tenantName}}','{{tenantServiceInfo.service_alias}}')
           	});
            
            
        	extPushWebSocketClient.prototype = {
       			onMessage : function(msg) {
       				if(typeof(msg) !="undefined"){
	       				var msgs = msg.split(":")
	       				if(msgs[0].trim()=="deploy"){
	       					var newMsg = msg.substr(7)
	       					log = eval("(" + newMsg + ")");  
	       					var showlog = log["create_time"]+" @"+log["user_id"] +" "+log["desc"]
	       					if(log["status"] == "end"){
	       						showlog = showlog+" 用时"+log["cost_time"]+"s";
	       					}
							showlog = "<label>"+showlog+"</label><p id='compile_"+log["event_id"]+"' style='display: none;'></p>"
							if($("#event_"+log["event_id"]).length>0){
								$("#event_"+log["event_id"]).html(showlog)
							}else{
								showlog = "<div id='event_"+log["event_id"]+"'>"+showlog+"</div>"
								var arr=$("#keylog").html().split('<br>');
		       					if(arr[0].trim() != newMsg.trim()){
		       						var finalMsg = showlog + $("#keylog").html()
		           					$("#keylog").html(finalMsg)
		       					}
							}
	       				}else if(msgs[0].trim()=="compile"){
	       					var event_id= msgs[1]
	       					var newMsg = msg.substr(25)
	       					var arr=$("#compile_"+event_id+"").html().split('<br>');
	   						if(arr[0].trim() != newMsg.trim()){
	   							var finalMsg = newMsg +"<br/>"+ $("#compile_"+event_id+"").html()
	           					$("#compile_"+event_id+"").html(finalMsg)
	           					$("#compile_"+event_id+"").show();
	   						}
	       				}else{
	       					var finalMsg=""
	       					var arr=$("#log").html().split('<br>');
	       					var totalSize=150;
	       					if(arr.length > totalSize){
	       						for(var i = 0; i < totalSize; i++){
	       							finalMsg += arr[totalSize-1-i]+"<br/>"
	       						}
	       					}else{
	       						finalMsg = $("#log").html()
	       					}
	       					finalMsg = msg.substr(14) +"<br/>"+ finalMsg
	       					$("#log").html(finalMsg)
	       				}
       				}
       			}
        	}
       		var connect = new extPushWebSocketConnect('{{websocket_uri}}');
       		connect.init(new extPushWebSocketClient(),service_id, "submsg", "submsg","123456789","987654321");
        });

		function getLog(action){
			var service_name=$("#service_name").val()
			if(service_name!="" && service_name != undefined ){
				$.ajax({
		       	  type: "GET",
		    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/log",
		    		  data: "action="+action,
		    		  cache: false,
		    		  beforeSend: function(xhr, settings){
		    		      var csrftoken = $.cookie('csrftoken');
		    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
		    		  },
		    	  	  success: function(msg) {
		    	  		var dataObj = msg;
		    	  		if(action=="operate"){
		    	  			var showlog=""
		    	  			var logList = dataObj["log"]
		    	  			if(typeof(logList) !="undefined"){
		    	  				for(var i=0;i<logList.length;i++){
			    	  				var log = logList[i]
			    	  				var tmpLog = log["create_time"]+" @"+log["user_id"] +" "+log["desc"]
			       					if(log["status"] == "end"){
			       						tmpLog = tmpLog+" 用时"+log["cost_time"]+"s";
			       					}
			    	  				tmpLog = "<label>"+tmpLog+"</label><p id='compile_"+log["event_id"]+"' style='display: none;'></p>"
			    	  				tmpLog = "<div id='event_"+log["event_id"]+"'>"+tmpLog+"</div>"
			    	  				showlog =showlog + tmpLog
			    	  			}
			    	  			$("#keylog").html(showlog)
		    	  			}		    	  			
			    	  	}else if(action=="service"){
			    	  		$("#log").html(dataObj["log"])
				    	}
		    		  },
		    		  error: function(){
		    			//swal("系统异常");
		      	  	}
		       })
			}
		}
        
        function getMappingPort(){
        	$.ajax({
	       	  type: "GET",
	    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/mapping-port",
	    		  cache: false,
	    		  beforeSend: function(xhr, settings){
	    		      var csrftoken = $.cookie('csrftoken');
	    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
	    		  },
	    	  	  success: function(msg) {
	    	  		var dataObj = msg;
	    	  		port = dataObj["port"]
	    	  		ip = dataObj["ip"]
	    	  		if(port > 0){
	    	  			if(port >= 2000){
	    	  				$('#mapping-port').html(port)
	    	  			}
	    	  			clearInterval(setIntertimmer);
	    	  		}
	    		  },
	    		  error: function(){
	    			//swal("系统异常");
	      	  	}
	       })
		}
        
        function do_logshow(event_id,deploy_version){
        	if($("#showlog_"+event_id+"").html() == "显示构建日志"){
        		if($("#compile_"+event_id+"").html() == ""){
        			$("#compile_"+event_id+"").show();
        			$.ajax({
           	       	  type: "GET",
           	    		  url: "/ajax/{{tenantName}}/{{serviceAlias}}/log",
           	    		  data: "action=compile&event_id="+event_id,
           	    		  cache: false,
           	    		  beforeSend: function(xhr, settings){
           	    		      var csrftoken = $.cookie('csrftoken');
           	    		      xhr.setRequestHeader("X-CSRFToken", csrftoken);
           	    		  },
           	    	  	  success: function(msg) {
           	    	  		var dataObj = msg;
           	    	  		var log = dataObj["log"];
           	    	  		$("#compile_"+event_id+"").html(log)
           	    	  		$("#showlog_"+event_id+"").html("隐藏构建日志")
           	    		  },
           	    		  error: function(){
           	    			//swal("系统异常");
           	      	      }
              	    })
        		}else{
        			$("#compile_"+event_id+"").show();
        			$("#showlog_"+event_id+"").html("隐藏构建日志")
        		}        		
    		}else{
    			$("#compile_"+event_id+"").hide();
    			$("#showlog_"+event_id+"").html("显示构建日志")
    		}        	
        }
        
        function do_rollback(event_id,deploy_version){
        	swal({
        		title : "确定恢复当前版本吗？",
        		type : "warning",
        		showCancelButton : true,
        		confirmButtonColor : "#DD6B55",
        		confirmButtonText : "确定",
        		cancelButtonText : "取消",
        		closeOnConfirm : false,
        		closeOnCancel : false
        	}, function(isConfirm) {
        		if (isConfirm) {
        			$.ajax({
                		type : "POST",
                		url : "/ajax/{{tenantName}}/{{tenantServiceInfo.service_alias}}/manage",
                		data : "event_id=" + event_id + "&action=rollback&deploy_version="+deploy_version,
                		cache : false,
                		beforeSend : function(xhr, settings) {
                			var csrftoken = $.cookie('csrftoken');
                			xhr.setRequestHeader("X-CSRFToken", csrftoken);
                		},
                		success : function(msg) {
                			var dataObj = msg
                			if (dataObj["status"] == "success") {
                				swal("操作成功")
                			} else if (dataObj["status"] == "often") {
                				swal("操作正在进行中，请稍后")
                			} else if (dataObj["status"] == "owed") {
                				swal("余额不足请及时充值")
                			} else if (dataObj["status"] == "over_memory") {
                				swal("免费资源已达上限，不能升级")
                			} else if (dataObj["status"] == "over_money") {
                				swal("余额不足，不能升级")
                			} else {
                				swal("操作失败")
                			}
                		},
                		error : function() {
                			swal("系统异常");
                			$("#operate_"+service_id).removeAttr("disabled")
                		}
                	});
        		} else {
        			swal.close();
        		}
        	});
        }
    </script>
</section>
</section>

{% endif %}

{% endblock %}
